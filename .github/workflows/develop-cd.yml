name: develop-cd

on:
  push:
    branches: ["main"]

concurrency:
  group: develop-cd-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 코드 가져오기
        uses: actions/checkout@v4

      - name: JDK 17 설치
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Gradle 설정
        uses: gradle/actions/setup-gradle@v3

      - name: gradlew 권한 설정
        run: chmod +x gradlew

      - name: application-dev.yml 생성
        env:
          APPLICATION_DEV: ${{ secrets.APPLICATION_DEV }}
        run: |
          FILE=src/main/resources/application-dev.yml
          rm -f "$FILE"
          printf '%s\n' "$APPLICATION_DEV" > "$FILE"

          if grep -Eq '^[[:space:]]*on-profile:[[:space:]]*local' "$FILE"; then
            echo "[WARN] application-dev.yml의 on-profile: local 을 dev로 보정합니다."
            perl -0pi -e 's/on-profile:\s*local/on-profile: dev/g' "$FILE"
          fi

      - name: dev 설정 필수값 검증
        run: |
          FILE=src/main/resources/application-dev.yml
          grep -Eq '^spring:' "$FILE" || { echo "[ERROR] spring 루트가 없습니다."; exit 1; }
          grep -Eq '^[[:space:]]*datasource:' "$FILE" || { echo "[ERROR] spring.datasource 블록이 없습니다."; exit 1; }
          grep -Eq '^[[:space:]]*url:[[:space:]]*jdbc:' "$FILE" || { echo "[ERROR] spring.datasource.url이 jdbc 형식이 아닙니다."; exit 1; }
          grep -Eq '^[[:space:]]*username:[[:space:]]*[^[:space:]].*' "$FILE" || { echo "[ERROR] spring.datasource.username이 비어 있습니다."; exit 1; }
          grep -Eq '^[[:space:]]*password:[[:space:]]*[^[:space:]].*' "$FILE" || { echo "[ERROR] spring.datasource.password가 비어 있습니다."; exit 1; }
          ! grep -Eq '^[[:space:]]*on-profile:[[:space:]]*local' "$FILE" || { echo "[ERROR] on-profile: local 이 남아 있습니다."; exit 1; }

      - name: 배포 스크립트 문법 검증
        run: bash -n deploy/ec2/blue_green_deploy.sh

      - name: Jib 이미지 빌드 및 푸시
        env:
          DOCKER_REPO: ${{ secrets.DOCKER_REPO }}
          IMAGE_SHA: ${{ github.sha }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          ./gradlew jib -x test --no-daemon --build-cache \
            -Djib.from.auth.username="${DOCKER_USERNAME}" \
            -Djib.from.auth.password="${DOCKER_PASSWORD}" \
            -Djib.to.image="${DOCKER_REPO}" \
            -Djib.to.tags="${IMAGE_SHA},main-latest" \
            -Djib.to.auth.username="${DOCKER_USERNAME}" \
            -Djib.to.auth.password="${DOCKER_PASSWORD}"

      - name: 배포 스크립트 전송
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: deploy/ec2/blue_green_deploy.sh
          target: /tmp

      - name: EC2 Blue/Green 배포
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            chmod +x /tmp/deploy/ec2/blue_green_deploy.sh
            export APP_NAME="ecogad"
            export DOCKER_REPO="${{ secrets.DOCKER_REPO }}"
            export IMAGE_TAG="${{ github.sha }}"
            export SPRING_PROFILES_ACTIVE="dev"
            export HEALTH_PATH="/actuator/health"
            sudo -E /tmp/deploy/ec2/blue_green_deploy.sh
